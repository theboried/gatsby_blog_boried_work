{"version":3,"sources":["../../src/utils/webpack-utils.js"],"names":["os","require","autoprefixer","ExtractTextPlugin","flexbugs","UglifyPlugin","builtinPlugins","createBabelConfig","module","exports","stage","program","assetRelativeRoot","vendorRegex","supportedBrowsers","browserlist","PRODUCTION","includes","babelConfig","makeExternalOnly","original","options","rule","include","makeInternalOnly","exclude","ident","loaders","json","loader","resolve","yaml","null","raw","style","css","minimize","sourceMap","camelCase","localIdentName","postcss","plugins","browsers","postcssOpts","flexbox","file","name","url","limit","js","imports","rules","test","use","fonts","images","audioVideo","extract","fallback","importLoaders","internal","external","cssModules","modules","uglify","uglifyOptions","cache","parallel","cpus","length","compress","drop_console","ecma","ie8","extractText","filename","allChunks","disable","ignoreOrder","args","moment","ignore"],"mappings":"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","file":"webpack-utils.js","sourcesContent":["// @flow\nconst os = require(`os`)\n\nconst autoprefixer = require(`autoprefixer`)\nconst ExtractTextPlugin = require(`extract-text-webpack-plugin`)\nconst flexbugs = require(`postcss-flexbugs-fixes`)\nconst UglifyPlugin = require(`uglifyjs-webpack-plugin`)\n\nconst builtinPlugins = require(`./webpack-plugins`)\nconst { createBabelConfig } = require(`./babel-config`)\n\ntype LoaderSpec = string | { loader: string, options?: Object }\ntype LoaderResolver<T: Object> = (options?: T) => LoaderSpec\n\ntype Condition = string | RegExp | RegExp[]\n\ntype Rule = {\n  test?: Condition,\n  use: LoaderSpec[],\n  exclude?: Condition,\n  include?: Condition,\n}\n\ntype RuleFactory<T: Object> = (options?: T) => Rule\n\ntype ContextualRuleFactory = RuleFactory<*> & {\n  internal: RuleFactory<*>,\n  external: RuleFactory<*>,\n}\n\ntype PluginInstance = any\ntype PluginFactory = (...args?: any) => PluginInstance\n\ntype BuiltinPlugins = typeof builtinPlugins\n\ntype Stage =\n  | \"develop\"\n  | \"develop-html\"\n  | \"build-css\"\n  | \"build-html\"\n  | \"build-javascript\"\n\n/**\n * Configuration options for `createUtils`\n */\nexport type WebpackUtilsOptions = { stage: Stage, program: any }\n\n/**\n * Utils that produce webpack `loader` objects\n */\nexport type LoaderUtils = {\n  json: LoaderResolver<*>,\n  yaml: LoaderResolver<*>,\n  null: LoaderResolver<*>,\n  raw: LoaderResolver<*>,\n\n  style: LoaderResolver<*>,\n  css: LoaderResolver<*>,\n  postcss: LoaderResolver<{\n    browsers?: string[],\n    plugins?: Array<any> | ((loader: any) => Array<any>),\n  }>,\n\n  file: LoaderResolver<*>,\n  url: LoaderResolver<*>,\n  js: LoaderResolver<*>,\n\n  imports: LoaderResolver<*>,\n  exports: LoaderResolver<*>,\n}\n\n/**\n * Utils that prodcue webpack rule objects\n */\nexport type RuleUtils = {\n  /**\n   * Handles Javascript compilation via babel\n   */\n  js: RuleFactory<*>,\n  yaml: RuleFactory<*>,\n  fonts: RuleFactory<*>,\n  images: RuleFactory<*>,\n  audioVideo: RuleFactory<*>,\n\n  css: ContextualRuleFactory,\n  cssModules: RuleFactory<*>,\n  postcss: ContextualRuleFactory,\n}\n\nexport type PluginUtils = BuiltinPlugins & {\n  extractText: PluginFactory,\n  uglify: PluginFactory,\n  moment: PluginFactory,\n}\n\n/**\n * webpack atoms namespace\n */\nexport type WebpackUtils = {\n  loaders: LoaderUtils,\n\n  rules: RuleUtils,\n\n  plugins: PluginUtils,\n}\n\n/**\n * A factory method that produces an atoms namespace\n */\nmodule.exports = async ({\n  stage,\n  program,\n}: {\n  stage: Stage,\n  program: any,\n}): Promise<WebpackUtilsOptions> => {\n  const assetRelativeRoot = `static/`\n  const vendorRegex = /(node_modules|bower_components)/\n  const supportedBrowsers = program.browserlist\n\n  const PRODUCTION = !stage.includes(`develop`)\n\n  const babelConfig = await createBabelConfig(program, stage)\n\n  const makeExternalOnly = (original: RuleFactory<*>) => (\n    options = {}\n  ): Rule => {\n    let rule = original(options)\n    rule.include = vendorRegex\n    return rule\n  }\n\n  const makeInternalOnly = (original: RuleFactory<*>) => (\n    options = {}\n  ): Rule => {\n    let rule = original(options)\n    rule.exclude = vendorRegex\n    return rule\n  }\n\n  let ident = 0\n\n  const loaders: LoaderUtils = {\n    json: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`json-loader`),\n      }\n    },\n\n    yaml: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`yaml-loader`),\n      }\n    },\n\n    null: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`null-loader`),\n      }\n    },\n\n    raw: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`raw-loader`),\n      }\n    },\n\n    style: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`style-loader`),\n      }\n    },\n\n    css: (options = {}) => {\n      return {\n        loader: require.resolve(`css-loader`),\n        options: {\n          minimize: PRODUCTION,\n          sourceMap: !PRODUCTION,\n          camelCase: `dashesOnly`,\n          // https://github.com/webpack-contrib/css-loader/issues/406\n          localIdentName: `[name]--[local]--[hash:base64:5]`,\n          ...options,\n        },\n      }\n    },\n\n    postcss: (options = {}) => {\n      let { plugins, browsers = supportedBrowsers, ...postcssOpts } = options\n\n      return {\n        loader: require.resolve(`postcss-loader`),\n        options: {\n          ident: `postcss-${++ident}`,\n          sourceMap: !PRODUCTION,\n          plugins: loader => {\n            plugins =\n              (typeof plugins === `function` ? plugins(loader) : plugins) || []\n\n            return [\n              flexbugs,\n              autoprefixer({ browsers, flexbox: `no-2009` }),\n              ...plugins,\n            ]\n          },\n          ...postcssOpts,\n        },\n      }\n    },\n\n    file: (options = {}) => {\n      return {\n        loader: require.resolve(`url-loader`),\n        options: {\n          name: `${assetRelativeRoot}[name]-[hash].[ext]`,\n          ...options,\n        },\n      }\n    },\n\n    url: (options = {}) => {\n      return {\n        loader: require.resolve(`url-loader`),\n        options: {\n          limit: 10000,\n          name: `${assetRelativeRoot}[name]-[hash].[ext]`,\n          ...options,\n        },\n      }\n    },\n\n    js: (options = babelConfig) => {\n      return {\n        options,\n        loader: require.resolve(`babel-loader`),\n      }\n    },\n\n    imports: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`imports-loader`),\n      }\n    },\n\n    exports: (options = {}) => {\n      return {\n        options,\n        loader: require.resolve(`exports-loader`),\n      }\n    },\n  }\n\n  /**\n   * Rules\n   */\n  const rules = {}\n\n  /**\n   * Javascript loader via babel, excludes node_modules\n   */\n  {\n    let js = options => {\n      return {\n        test: /\\.jsx?$/,\n        exclude: vendorRegex,\n        use: [loaders.js(options)],\n      }\n    }\n\n    rules.js = js\n  }\n\n  rules.yaml = () => {\n    return {\n      test: /\\.ya?ml/,\n      use: [loaders.json(), loaders.yaml()],\n    }\n  }\n\n  /**\n   * Font loader\n   */\n  rules.fonts = () => {\n    return {\n      use: [loaders.url()],\n      test: /\\.(eot|otf|ttf|woff(2)?)(\\?.*)?$/,\n    }\n  }\n\n  /**\n   * Loads image assets, inlines images via a data URI if they are below\n   * the size threshold\n   */\n  rules.images = () => {\n    return {\n      use: [loaders.url()],\n      test: /\\.(ico|svg|jpg|jpeg|png|gif|webp)(\\?.*)?$/,\n    }\n  }\n\n  /**\n   * Loads audio or video assets\n   */\n  rules.audioVideo = () => {\n    return {\n      use: [loaders.file()],\n      test: /\\.(mp4|webm|wav|mp3|m4a|aac|oga|flac)$/,\n    }\n  }\n\n  /**\n   * CSS style loader.\n   */\n  {\n    const css = ({ browsers, ...options } = {}) => {\n      return {\n        test: /\\.css$/,\n        use: ExtractTextPlugin.extract({\n          fallback: loaders.style(),\n          use: [\n            loaders.css({ ...options, importLoaders: 1 }),\n            loaders.postcss({ browsers }),\n          ],\n        }),\n      }\n    }\n\n    /**\n     * CSS style loader, _excludes_ node_modules.\n     */\n    css.internal = makeInternalOnly(css)\n    css.external = makeExternalOnly(css)\n\n    const cssModules = options => {\n      const rule = css({ ...options, modules: true })\n      delete rule.exclude\n      rule.test = /\\.module\\.css$/\n      return rule\n    }\n\n    rules.css = css\n    rules.cssModules = cssModules\n  }\n\n  /**\n   * PostCSS loader.\n   */\n  {\n    const postcss = options => {\n      return {\n        test: /\\.css$/,\n        use: ExtractTextPlugin.extract({\n          fallback: loaders.style(),\n          use: [loaders.css({ importLoaders: 1 }), loaders.postcss(options)],\n        }),\n      }\n    }\n\n    /**\n     * PostCSS loader, _excludes_ node_modules.\n     */\n    postcss.internal = makeInternalOnly(postcss)\n    postcss.external = makeExternalOnly(postcss)\n    rules.postcss = postcss\n  }\n  /**\n   * Plugins\n   */\n  const plugins = { ...builtinPlugins }\n\n  /**\n   * Minify javascript code without regard for IE8. Attempts\n   * to parallelize the work to save time. Generally only add in Production\n   */\n  plugins.uglify = ({ uglifyOptions, ...options } = {}) =>\n    new UglifyPlugin({\n      cache: true,\n      parallel: os.cpus().length - 1,\n      exclude: /\\.min\\.js/,\n      sourceMap: true,\n      uglifyOptions: {\n        compress: {\n          drop_console: true,\n        },\n        ecma: 8,\n        ie8: false,\n        ...uglifyOptions,\n      },\n      ...options,\n    })\n\n  /**\n   * Extracts css requires into a single file;\n   * includes some reasonable defaults\n   */\n  plugins.extractText = options =>\n    new ExtractTextPlugin({\n      filename: `[name]-[contenthash].css`,\n      allChunks: true,\n      disable: !PRODUCTION,\n      // Useful when using css modules\n      ignoreOrder: true,\n      ...options,\n    })\n\n  plugins.extractText.extract = (...args) => ExtractTextPlugin.extract(...args)\n\n  plugins.moment = () => plugins.ignore(/^\\.\\/locale$/, /moment$/)\n\n  return {\n    loaders,\n    rules: (rules: RuleUtils),\n    plugins: (plugins: PluginUtils),\n  }\n}\n"]}