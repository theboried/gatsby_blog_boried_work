{"version":3,"sources":["../../src/utils/webpack.config.js"],"names":["require","uniq","some","fs","path","dotenv","StaticSiteGeneratorPlugin","NameAllModulesPlugin","StatsWriterPlugin","WatchMissingNodeModulesPlugin","store","actions","debug","WebpackMD5Hash","GatsbyModulePlugin","report","withBasePath","chunkNamer","apiRunnerNode","createUtils","module","exports","program","directory","suppliedStage","webpackPort","pages","directoryPath","stage","rules","loaders","plugins","processEnv","defaultNodeEnv","env","process","NODE_ENV","envFile","join","cwd","parsed","parse","readFileSync","encoding","err","code","error","envObject","Object","keys","reduce","acc","key","JSON","stringify","gatsbyVarObject","match","PUBLIC_DIR","assign","getOutput","filename","publicPath","host","pathinfo","devtoolModuleFilenameTemplate","info","resolve","absoluteResourcePath","replace","prefixPaths","getState","config","pathPrefix","libraryTarget","chunkFilename","Error","getEntry","commons","main","app","getPlugins","configPlugins","moment","define","__PREFIX_PATHS__","__PATH_PREFIX__","extractText","concat","hotModuleReplacement","noEmitOnErrors","namedModules","namedChunks","components","map","page","componentChunkName","push","commonsChunk","name","chunks","minChunks","count","vendorModuleList","cacheDirList","isFramework","vendor","regex","RegExp","test","resource","isRuntime","runtime","uglify","uglifyOptions","compress","drop_console","getDevtool","getModule","configRules","js","yaml","fonts","images","audioVideo","css","cssModules","use","null","getResolve","extensions","modules","getResolveLoader","root","userLoaderDirectoryPath","statSync","isDirectory","__dirname","context","entry","output","target","profile","devtool","performance","hints","resolveLoader","node","__filename","dispatch","replaceWebpackConfig","getConfig","webpack"],"mappings":"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","file":"webpack.config.js","sourcesContent":["require(`v8-compile-cache`)\n\nconst { uniq, some } = require(`lodash`)\nconst fs = require(`fs`)\nconst path = require(`path`)\nconst dotenv = require(`dotenv`)\nconst StaticSiteGeneratorPlugin = require(`static-site-generator-webpack-plugin`)\nconst NameAllModulesPlugin = require(`name-all-modules-plugin`)\nconst { StatsWriterPlugin } = require(`webpack-stats-plugin`)\n// const FriendlyErrorsWebpackPlugin = require(`friendly-errors-webpack-plugin`)\nconst WatchMissingNodeModulesPlugin = require(`react-dev-utils/WatchMissingNodeModulesPlugin`)\nconst { store } = require(`../redux`)\nconst { actions } = require(`../redux/actions`)\nconst debug = require(`debug`)(`gatsby:webpack-config`)\nconst WebpackMD5Hash = require(`webpack-md5-hash`)\nconst GatsbyModulePlugin = require(`gatsby-module-loader/plugin`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst { withBasePath } = require(`./path`)\nconst { chunkNamer } = require(`./webpack-helpers`)\n\nconst apiRunnerNode = require(`./api-runner-node`)\nconst createUtils = require(`./webpack-utils`)\n\n// Five stages or modes:\n//   1) develop: for `gatsby develop` command, hot reload and CSS injection into page\n//   2) develop-html: same as develop without react-hmre in the babel config for html renderer\n//   3) build-css: build styles.css file\n//   4) build-html: build all HTML files\n//   5) build-javascript: Build js chunks for Single Page App in production\n\nmodule.exports = async (\n  program,\n  directory,\n  suppliedStage,\n  webpackPort = 1500,\n  pages = []\n) => {\n  const directoryPath = withBasePath(directory)\n\n  // We combine develop & develop-html stages for purposes of generating the\n  // webpack config.\n  const stage = suppliedStage\n  const { rules, loaders, plugins } = await createUtils({ stage, program })\n\n  function processEnv(stage, defaultNodeEnv) {\n    debug(`Building env for \"${stage}\"`)\n    const env = process.env.NODE_ENV\n      ? process.env.NODE_ENV\n      : `${defaultNodeEnv}`\n    const envFile = path.join(process.cwd(), `./.env.${env}`)\n    let parsed = {}\n    try {\n      parsed = dotenv.parse(fs.readFileSync(envFile, { encoding: `utf8` }))\n    } catch (err) {\n      if (err.code !== `ENOENT`) {\n        report.error(`There was a problem processing the .env file`, err)\n      }\n    }\n\n    const envObject = Object.keys(parsed).reduce((acc, key) => {\n      acc[key] = JSON.stringify(parsed[key])\n      return acc\n    }, {})\n\n    const gatsbyVarObject = Object.keys(process.env).reduce((acc, key) => {\n      if (key.match(/^GATSBY_/)) {\n        acc[key] = JSON.stringify(process.env[key])\n      }\n      return acc\n    }, {})\n\n    // Don't allow overwriting of NODE_ENV, PUBLIC_DIR as to not break gatsby things\n    envObject.NODE_ENV = JSON.stringify(env)\n    envObject.PUBLIC_DIR = JSON.stringify(`${process.cwd()}/public`)\n\n    return Object.assign(envObject, gatsbyVarObject)\n  }\n\n  debug(`Loading webpack config for stage \"${stage}\"`)\n  function getOutput() {\n    switch (stage) {\n      case `develop`:\n        return {\n          path: directory,\n          filename: `[name].js`,\n          publicPath: `http://${program.host}:${webpackPort}/`,\n          // Add /* filename */ comments to generated require()s in the output.\n          pathinfo: true,\n          // Point sourcemap entries to original disk location (format as URL on Windows)\n          devtoolModuleFilenameTemplate: info =>\n            path.resolve(info.absoluteResourcePath).replace(/\\\\/g, `/`),\n        }\n      case `build-css`:\n        // Webpack will always generate a resultant javascript file.\n        // But we don't want it for this step. Deleted by build-css.js.\n        return {\n          path: directoryPath(`public`),\n          filename: `bundle-for-css.js`,\n          publicPath: program.prefixPaths\n            ? `${store.getState().config.pathPrefix}/`\n            : `/`,\n        }\n      case `build-html`:\n      case `develop-html`:\n        // A temp file required by static-site-generator-plugin. See plugins() below.\n        // Deleted by build-html.js, since it's not needed for production.\n        return {\n          path: directoryPath(`public`),\n          filename: `[name].render-page.js`,\n          libraryTarget: `umd`,\n          publicPath: program.prefixPaths\n            ? `${store.getState().config.pathPrefix}/`\n            : `/`,\n        }\n      case `build-javascript`:\n        return {\n          filename: `[name]-[chunkhash].js`,\n          chunkFilename: `[name]-[chunkhash].js`,\n          path: directoryPath(`public`),\n          publicPath: program.prefixPaths\n            ? `${store.getState().config.pathPrefix}/`\n            : `/`,\n        }\n      default:\n        throw new Error(`The state requested ${stage} doesn't exist.`)\n    }\n  }\n\n  function getEntry() {\n    switch (stage) {\n      case `develop`:\n        return {\n          commons: [\n            require.resolve(`react-hot-loader/patch`),\n            `${require.resolve(`webpack-hot-middleware/client`)}?path=http://${\n              program.host\n            }:${webpackPort}/__webpack_hmr&reload=true&overlay=false`,\n            directoryPath(`.cache/app`),\n          ],\n        }\n      case `develop-html`:\n        return {\n          main: directoryPath(`.cache/develop-static-entry`),\n        }\n      case `build-css`:\n        return {\n          main: directoryPath(`.cache/app`),\n        }\n      case `build-html`:\n        return {\n          main: directoryPath(`.cache/static-entry`),\n        }\n      case `build-javascript`:\n        return {\n          app: directoryPath(`.cache/production-app`),\n        }\n      default:\n        throw new Error(`The state requested ${stage} doesn't exist.`)\n    }\n  }\n\n  function getPlugins() {\n    let configPlugins = [\n      plugins.moment(),\n\n      // Add a few global variables. Set NODE_ENV to production (enables\n      // optimizations for React) and whether prefixing links is enabled\n      // (__PREFIX_PATHS__) and what the link prefix is (__PATH_PREFIX__).\n      plugins.define({\n        \"process.env\": processEnv(stage, `development`),\n        __PREFIX_PATHS__: program.prefixPaths,\n        __PATH_PREFIX__: JSON.stringify(store.getState().config.pathPrefix),\n      }),\n\n      plugins.extractText({\n        filename: stage === `build-css` ? `styles.css` : `${stage}.css`,\n      }),\n    ]\n\n    switch (stage) {\n      case `develop`:\n        configPlugins = configPlugins.concat([\n          plugins.hotModuleReplacement(),\n          plugins.noEmitOnErrors(),\n\n          // If you require a missing module and then `npm install` it, you still have\n          // to restart the development server for Webpack to discover it. This plugin\n          // makes the discovery automatic so you don't have to restart.\n          // See https://github.com/facebookincubator/create-react-app/issues/186\n          new WatchMissingNodeModulesPlugin(directoryPath(`node_modules`)),\n\n          new NameAllModulesPlugin(),\n          plugins.namedModules(),\n          // new FriendlyErrorsWebpackPlugin({\n          // clearConsole: false,\n          // compilationSuccessInfo: {\n          // messages: [\n          // `You can now view your site in the browser running at http://${\n          // program.host\n          // }:${program.port}`,\n          // `Your graphql debugger is running at http://${program.host}:${\n          // program.port\n          // }/___graphql`,\n          // ],\n          // },\n          // }),\n        ])\n        break\n\n      case `develop-html`:\n      case `build-html`:\n        configPlugins = configPlugins.concat([\n          new StaticSiteGeneratorPlugin(`main.render-page.js`, pages),\n          plugins.namedModules(),\n          plugins.namedChunks(chunkNamer),\n          new NameAllModulesPlugin(),\n        ])\n        break\n      case `build-javascript`: {\n        // Get array of page template component names.\n        let components = store\n          .getState()\n          .pages.map(page => page.componentChunkName)\n\n        components = uniq(components)\n        components.push(`layout-component---index`)\n\n        configPlugins = configPlugins.concat([\n          plugins.namedModules(),\n          plugins.namedChunks(chunkNamer),\n          new NameAllModulesPlugin(),\n          new WebpackMD5Hash(),\n\n          // Extract \"commons\" chunk from the app entry and all\n          // page components.\n          plugins.commonsChunk({\n            name: `commons`,\n            chunks: [`app`, ...components],\n            // The more page components there are, the higher we raise the bar\n            // for merging in page-specific JS libs into the commons chunk. The\n            // two principles here is a) keep the TTI (time to interaction) as\n            // low as possible so that means keeping commons.js small with\n            // critical framework code (e.g. React/react-router) and b) is we\n            // want to push JS parse/eval work as close as possible to when\n            // it's used. Since most people don't navigate to most pages, take\n            // tradeoff of loading/evaling modules multiple times over\n            // loading/evaling lots of unused code on the initial opening of\n            // the app.\n            minChunks: (module, count) => {\n              const vendorModuleList = [\n                `react`,\n                `react-dom`,\n                `fbjs`,\n                `react-router`,\n                `react-router-dom`,\n                `gatsby-react-router-scroll`,\n                `dom-helpers`, // Used in gatsby-react-router-scroll\n                `path-to-regexp`,\n                `isarray`, // Used by path-to-regexp.\n                `scroll-behavior`,\n                `history`,\n                `domready`,\n                `resolve-pathname`, // Used by history.\n                `value-equal`, // Used by history.\n                `invariant`, // Used by history.\n                `warning`, // Used by history.\n                `babel-runtime`, // Used by history.\n                `core-js`, // Used by history.\n                `loose-envify`, // Used by history.\n                `prop-types`,\n                `gatsby-link`,\n                `mitt`,\n                `shallow-compare`,\n              ]\n              const cacheDirList = [\n                `production-app`,\n                `loader`,\n                `prefetcher`,\n                `find-page`,\n                `component-renderer`,\n                `emitter`,\n                `register-service-worker`,\n                `strip-prefix`,\n                `history`,\n              ]\n\n              const isFramework = some(\n                vendorModuleList.map(vendor => {\n                  const regex = new RegExp(\n                    `[\\\\\\\\/]node_modules[\\\\\\\\/]${vendor}[\\\\\\\\/].*`,\n                    `i`\n                  )\n                  return regex.test(module.resource)\n                })\n              )\n\n              const isRuntime = some(\n                cacheDirList.map(runtime => {\n                  const regex = new RegExp(`.*cache[\\\\\\\\/]${runtime}.*`, `i`)\n                  return regex.test(module.resource)\n                })\n              )\n\n              return isFramework || isRuntime || count > 3\n            },\n          }),\n\n          // using a chunk name that doesn't exist creates a chunk with\n          // just the runtime bits\n          plugins.commonsChunk({\n            name: `@@webpack-runtime`,\n            filename: `@@webpack-runtime.js`,\n          }),\n          // Write out mapping between chunk names and their hashed names. We use\n          // this to add the needed javascript files to each HTML page.\n          new StatsWriterPlugin(),\n\n          // Minify Javascript.\n          plugins.uglify({\n            uglifyOptions: {\n              compress: {\n                drop_console: false,\n              },\n            },\n          }),\n          new GatsbyModulePlugin(),\n          plugins.namedModules(),\n          plugins.namedChunks(chunkNamer),\n        ])\n        break\n      }\n    }\n\n    return configPlugins\n  }\n\n  function getDevtool() {\n    switch (stage) {\n      case `develop`:\n        return `cheap-module-source-map`\n      // use a normal `source-map` for the html phases since\n      // it gives better line and column numbers\n      case `develop-html`:\n      case `build-html`:\n      case `build-javascript`:\n        return `source-map`\n      default:\n        return false\n    }\n  }\n\n  function getModule(config) {\n    // Common config for every env.\n    // prettier-ignore\n    let configRules = [\n      rules.js(),\n      rules.yaml(),\n      rules.fonts(),\n      rules.images(),\n      rules.audioVideo(),\n    ]\n    switch (stage) {\n      case `develop`:\n      case `build-css`:\n        configRules = configRules.concat([rules.css(), rules.cssModules()])\n        break\n\n      case `build-html`:\n      case `develop-html`:\n        // We don't deal with CSS at all when building the HTML.\n        // The 'null' loader is used to prevent 'module not found' errors.\n        // On the other hand CSS modules loaders are necessary.\n\n        // prettier-ignore\n        configRules = configRules.concat([\n          {\n            ...rules.css(),\n            use: [loaders.null()],\n          },\n          rules.cssModules(),\n        ])\n        break\n\n      case `build-javascript`:\n        // we don't deal with css at all when building the javascript.  but\n        // still need to process the css so offline-plugin knows about the\n        // various assets referenced in your css.\n        //\n        // It's also necessary to process CSS Modules so your JS knows the\n        // classNames to use.\n        configRules = configRules.concat([rules.css(), rules.cssModules()])\n        break\n    }\n\n    return { rules: configRules }\n  }\n\n  function getResolve() {\n    const { program } = store.getState()\n    return {\n      // Use the program's extension list (generated via the\n      // 'resolvableExtensions' API hook).\n      extensions: [...program.extensions],\n      // Default to using the site's node_modules directory to look for\n      // modules. But also make it possible to install modules within the src\n      // directory if you need to install a specific version of a module for a\n      // part of your site.\n      modules: [\n        directoryPath(path.join(`src`, `node_modules`)),\n        directoryPath(`node_modules`),\n      ],\n    }\n  }\n\n  function getResolveLoader() {\n    const root = [path.resolve(directory, `node_modules`)]\n\n    const userLoaderDirectoryPath = path.resolve(directory, `loaders`)\n\n    try {\n      if (fs.statSync(userLoaderDirectoryPath).isDirectory()) {\n        root.push(userLoaderDirectoryPath)\n      }\n    } catch (err) {\n      debug(`Error resolving user loaders directory`, err)\n    }\n\n    return {\n      modules: [...root, path.join(__dirname, `../loaders`), `node_modules`],\n    }\n  }\n\n  const config = {\n    // Context is the base directory for resolving the entry option.\n    context: directory,\n    entry: getEntry(),\n    output: getOutput(),\n\n    module: getModule(),\n    plugins: getPlugins(),\n\n    // Certain \"isomorphic\" packages have different entry points for browser\n    // and server (see\n    // https://github.com/defunctzombie/package-browser-field-spec); setting\n    // the target tells webpack which file to include, ie. browser vs main.\n    target: stage === `build-html` || stage === `develop-html` ? `node` : `web`,\n    profile: stage === `production`,\n    devtool: getDevtool(),\n    // Turn off performance hints as we (for now) don't want to show the normal\n    // webpack output anywhere.\n    performance: {\n      hints: false,\n    },\n\n    resolveLoader: getResolveLoader(),\n    resolve: getResolve(),\n\n    node: {\n      __filename: true,\n    },\n  }\n\n  store.dispatch(actions.replaceWebpackConfig(config))\n  const getConfig = () => store.getState().webpack\n\n  await apiRunnerNode(`modifyWebpackConfig`, {\n    getConfig,\n    stage,\n    rules,\n    loaders,\n    plugins,\n  })\n\n  return getConfig()\n}\n"]}