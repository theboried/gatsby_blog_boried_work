{"version":3,"sources":["../../../src/bootstrap/load-plugins/load.js"],"names":["_","require","slash","fs","path","crypto","glob","createFileContentHash","root","globPattern","hash","createHash","files","sync","nodir","forEach","filepath","update","readFileSync","digest","resolvePlugin","pluginName","existsSync","resolvedPath","resolve","packageJSON","JSON","parse","name","id","version","Error","dirname","err","module","exports","config","plugins","processPlugin","plugin","isString","info","pluginOptions","subplugins","options","p","push","merge","internalPlugins","relPath","absPath","join","__dirname","process","cwd"],"mappings":"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","file":"load.js","sourcesContent":["const _ = require(`lodash`)\nconst slash = require(`slash`)\nconst fs = require(`fs`)\nconst path = require(`path`)\nconst crypto = require(`crypto`)\nconst glob = require(`glob`)\n\nfunction createFileContentHash(root, globPattern) {\n  const hash = crypto.createHash(`md5`)\n  const files = glob.sync(`${root}/${globPattern}`, { nodir: true })\n\n  files.forEach(filepath => {\n    hash.update(fs.readFileSync(filepath))\n  })\n\n  return hash.digest(`hex`)\n}\n\n/**\n * @typedef {Object} PluginInfo\n * @property {string} resolve The absolute path to the plugin\n * @property {string} name The plugin name\n * @property {string} version The plugin version (can be content hash)\n */\n\n/**\n * resolvePlugin\n * @param {string} pluginName\n * This can be a name of a local plugin, the name of a plugin located in\n * node_modules, or a Gatsby internal plugin. In the last case the pluginName\n * will be an absolute path.\n * @return {PluginInfo}\n */\nfunction resolvePlugin(pluginName) {\n  // Only find plugins when we're not given an absolute path\n  if (!fs.existsSync(pluginName)) {\n    // Find the plugin in the local plugins folder\n    const resolvedPath = slash(path.resolve(`./plugins/${pluginName}`))\n\n    if (fs.existsSync(resolvedPath)) {\n      if (fs.existsSync(`${resolvedPath}/package.json`)) {\n        const packageJSON = JSON.parse(\n          fs.readFileSync(`${resolvedPath}/package.json`, `utf-8`)\n        )\n\n        return {\n          resolve: resolvedPath,\n          name: packageJSON.name || pluginName,\n          id: `Plugin ${packageJSON.name || pluginName}`,\n          version:\n            packageJSON.version || createFileContentHash(resolvedPath, `**`),\n        }\n      } else {\n        // Make package.json a requirement for local plugins too\n        throw new Error(`Plugin ${pluginName} requires a package.json file`)\n      }\n    }\n  }\n\n  /**\n   * Here we have an absolute path to an internal plugin, or a name of a module\n   * which should be located in node_modules.\n   */\n  try {\n    const resolvedPath = slash(path.dirname(require.resolve(pluginName)))\n\n    const packageJSON = JSON.parse(\n      fs.readFileSync(`${resolvedPath}/package.json`, `utf-8`)\n    )\n\n    return {\n      resolve: resolvedPath,\n      id: `Plugin ${packageJSON.name}`,\n      name: packageJSON.name,\n      version: packageJSON.version,\n    }\n  } catch (err) {\n    throw new Error(`Unable to find plugin \"${pluginName}\"`)\n  }\n}\n\nmodule.exports = async (config = {}) => {\n  // Instantiate plugins.\n  const plugins = []\n\n  // Create fake little site with a plugin for testing this\n  // w/ snapshots. Move plugin processing to its own module.\n  // Also test adding to redux store.\n  const processPlugin = plugin => {\n    if (_.isString(plugin)) {\n      const info = resolvePlugin(plugin)\n\n      return {\n        ...info,\n        pluginOptions: {\n          plugins: [],\n        },\n      }\n    } else {\n      // Plugins can have plugins.\n      const subplugins = []\n      if (plugin.options && plugin.options.plugins) {\n        plugin.options.plugins.forEach(p => {\n          subplugins.push(processPlugin(p))\n        })\n\n        plugin.options.plugins = subplugins\n      }\n\n      // Add some default values for tests as we don't actually\n      // want to try to load anything during tests.\n      if (plugin.resolve === `___TEST___`) {\n        return {\n          name: `TEST`,\n          pluginOptions: {\n            plugins: [],\n          },\n        }\n      }\n\n      const info = resolvePlugin(plugin.resolve)\n\n      return {\n        ...info,\n        pluginOptions: _.merge({ plugins: [] }, plugin.options),\n      }\n    }\n  }\n\n  // Add internal plugins\n  const internalPlugins = [\n    `../../internal-plugins/dev-404-page`,\n    `../../internal-plugins/load-babel-config`,\n    `../../internal-plugins/component-page-creator`,\n    `../../internal-plugins/component-layout-creator`,\n    `../../internal-plugins/internal-data-bridge`,\n    `../../internal-plugins/prod-404`,\n    `../../internal-plugins/query-runner`,\n  ]\n  internalPlugins.forEach(relPath => {\n    const absPath = path.join(__dirname, relPath)\n    plugins.push(processPlugin(absPath))\n  })\n\n  // Add plugins from the site config.\n  if (config.plugins) {\n    config.plugins.forEach(plugin => {\n      plugins.push(processPlugin(plugin))\n    })\n  }\n\n  // Add the site's default \"plugin\" i.e. gatsby-x files in root of site.\n  plugins.push({\n    resolve: slash(process.cwd()),\n    id: `Plugin default-site-plugin`,\n    name: `default-site-plugin`,\n    version: createFileContentHash(process.cwd(), `gatsby-*`),\n    pluginOptions: {\n      plugins: [],\n    },\n  })\n\n  return plugins\n}\n"]}