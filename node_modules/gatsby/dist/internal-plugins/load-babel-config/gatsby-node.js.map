{"version":3,"sources":["../../../src/internal-plugins/load-babel-config/gatsby-node.js"],"names":["fs","require","path","json5","_","report","testRequireError","default","findBabelrc","directory","babelrcPath","join","existsSync","babelrc","readFileSync","parse","error","preferDefault","m","findBabelrcJs","stage","findBabelPackage","packageJson","babel","actionifyBabelrc","actions","presets","plugins","options","isArray","forEach","p","name","setBabelPreset","setBabelPlugin","isObject","isEmpty","setBabelOptions","exports","onCreateBabelConfig","store","program","getState","addDefaultPluginsPresets","browserslist","loose","modules","useBuiltIns","sourceType","shippedProposals","targets","browsers","pragma","development","helpers","regenerator","polyfill"],"mappings":"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","file":"gatsby-node.js","sourcesContent":["/* @flow */\n\nconst fs = require(`fs`)\nconst path = require(`path`)\nconst json5 = require(`json5`)\nconst _ = require(`lodash`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\nconst testRequireError = require(`../../utils/test-require-error`).default\n\n/**\n * Locates a .babelrc in the Gatsby site root directory. Parses it using\n * json5 (what Babel uses). It throws an error if the users's .babelrc is\n * not parseable.\n */\nfunction findBabelrc(directory) {\n  const babelrcPath = path.join(directory, `.babelrc`)\n  if (fs.existsSync(babelrcPath)) {\n    try {\n      const babelrc = fs.readFileSync(babelrcPath, `utf-8`)\n      return json5.parse(babelrc)\n    } catch (error) {\n      throw error\n    }\n  }\n  return null\n}\n\n/**\n * Locates a .babelrc.js in the Gatsby site root directory.\n * requires it and unwraps any esm default export\n */\nconst preferDefault = m => (m && m.default) || m\nfunction findBabelrcJs(directory, stage) {\n  let babelrc = null\n  const babelrcPath = path.join(directory, `.babelrc.js`)\n  try {\n    babelrc = preferDefault(require(babelrcPath))\n  } catch (error) {\n    if (!testRequireError(babelrcPath, error)) {\n      throw error\n    }\n  }\n\n  // TODO support this\n  if (typeof babelrc === `function`) {\n    report.error(\n      `.babelrc.js files that export a function are not supported in Gatsby`\n    )\n    return null\n  }\n\n  return babelrc\n}\n\n/**\n * Reads the user's package.json and returns the \"babel\" section. It will\n * return undefined when the \"babel\" section does not exist.\n */\nfunction findBabelPackage(directory) {\n  const packageJson = require(path.join(directory, `package.json`))\n  try {\n    // $FlowFixMe - https://github.com/facebook/flow/issues/1975\n    return packageJson.babel\n  } catch (error) {\n    if (testRequireError(packageJson, error)) {\n      return null\n    } else {\n      throw error\n    }\n  }\n}\n\n/**\n * Convert a babelrc from a .babelrc file or package.json\n * to actions to add it to the store.\n */\nconst actionifyBabelrc = (babelrc, actions) => {\n  const { presets, plugins, ...options } = babelrc\n  if (presets && _.isArray(presets)) {\n    presets.forEach(p => {\n      let name\n      let options = {}\n      if (_.isArray(p)) {\n        name = p[0]\n        options = p[1]\n      } else {\n        name = p\n      }\n      actions.setBabelPreset({\n        name,\n        options,\n      })\n    })\n  }\n  if (plugins && _.isArray(plugins)) {\n    plugins.forEach(p => {\n      let name\n      let options = {}\n      if (_.isArray(p)) {\n        name = p[0]\n        options = p[1]\n      } else {\n        name = p\n      }\n      actions.setBabelPlugin({\n        name,\n        options,\n      })\n    })\n  }\n\n  if (_.isObject(options) && !_.isEmpty(options)) {\n    actions.setBabelOptions({ options })\n  }\n}\n\nexports.actionifyBabelrc = actionifyBabelrc\n\n/**\n * Creates a normalized Babel config to use with babel-loader. Loads a local\n * babelrc config if one exists or sets a backup default.\n */\nexports.onCreateBabelConfig = ({ stage, store, actions }) => {\n  const program = store.getState().program\n  const { directory } = program\n\n  let babelrc =\n    findBabelrc(directory) ||\n    findBabelrcJs(directory) ||\n    findBabelPackage(directory)\n\n  // If user doesn't have a custom babelrc, add defaults.\n  if (babelrc) {\n    actionifyBabelrc(babelrc, actions)\n  } else {\n    addDefaultPluginsPresets(actions, {\n      stage,\n      browserslist: program.browserslist,\n    })\n  }\n}\n\nconst addDefaultPluginsPresets = (\n  actions,\n  { stage = ``, browserslist = {} }\n) => {\n  // Presets\n  actions.setBabelPreset({\n    name: `@babel/preset-env`,\n    stage,\n    options: {\n      loose: true,\n      modules: false,\n      useBuiltIns: `usage`,\n      sourceType: `unambiguous`,\n      shippedProposals: true, // includes async/await and Object spread/rest\n      targets: { browsers: browserslist },\n    },\n  })\n  actions.setBabelPreset({\n    name: `@babel/preset-react`,\n    stage,\n    options: {\n      useBuiltIns: true,\n      pragma: `React.createElement`,\n      development: stage === `develop`,\n    },\n  })\n  actions.setBabelPreset({ name: `@babel/preset-flow`, stage })\n\n  // Plugins\n  actions.setBabelPlugin({\n    name: `@babel/plugin-proposal-class-properties`,\n    stage,\n    options: { loose: true },\n  })\n  actions.setBabelPlugin({\n    name: `@babel/plugin-syntax-dynamic-import`,\n    stage,\n  })\n  // Polyfills the runtime needed for async/await and generators\n  actions.setBabelPlugin({\n    name: `@babel/plugin-transform-runtime`,\n    stage,\n    options: {\n      helpers: true,\n      regenerator: true,\n      polyfill: false,\n    },\n  })\n}\n\nexports.addDefaultPluginsPresets = addDefaultPluginsPresets\n"]}